#!/usr/bin/env bash

set -euo pipefail

# --- Configuration ---
NVIM_REPO_URL="https://github.com/neovim/neovim"
NVIM_INSTALL_PREFIX="/usr/local"
NVIM_VERSION_MIN="0.11"
DEVCONFIG_REPO_URL="git@gitlab.damp.local:niklas.werner/devconfig.git"
DOTFILES_CONFIG_DIR="$HOME/.config/dotfiles"
CONFIG_MODE=""

# --- Helper Functions ---
log() {
    echo "[dotfiles] $1"
}

error() {
    echo "[dotfiles] ERROR: $1" >&2
    exit 1
}

version_gte() {
    printf '%s\n%s\n' "$2" "$1" | sort -V -C
}

load_config_mode() {
    if [[ -f "$DOTFILES_CONFIG_DIR/mode" ]]; then
        CONFIG_MODE=$(cat "$DOTFILES_CONFIG_DIR/mode")
        return 0
    fi
    return 1
}

save_config_mode() {
    mkdir -p "$DOTFILES_CONFIG_DIR"
    echo "$CONFIG_MODE" > "$DOTFILES_CONFIG_DIR/mode"
}

prompt_config_mode() {
    echo
    echo "Is this a personal or work device?"
    echo "  [1] Personal"
    echo "  [2] Work"
    echo -n "> "
    read -r choice

    case "$choice" in
        1|"")
            CONFIG_MODE="personal"
            ;;
        2)
            CONFIG_MODE="work"
            ;;
        *)
            echo "Invalid choice. Defaulting to personal."
            CONFIG_MODE="personal"
            ;;
    esac

    save_config_mode
    log "Mode set to: $CONFIG_MODE"
}

check_nvim_version() {
    if ! command -v nvim &> /dev/null; then
        echo "not installed"
        return 1
    fi

    local version
    version=$(nvim --version 2>/dev/null | head -n1 | grep -oE '[0-9]+\.[0-9]+')

    if [[ -z "$version" ]]; then
        echo "unknown"
        return 1
    fi

    echo "$version"

    if version_gte "$version" "$NVIM_VERSION_MIN"; then
        return 0
    else
        return 1
    fi
}

install_neovim_from_source() {
    log "Installing Neovim from source (current: $(check_nvim_version))"

    if [[ "$(uname)" == "Darwin" ]]; then
        brew install cmake ninja luajit
    else
        sudo apt-get update
        sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libtool \
            gettext \
            libncurses-dev \
            luajit \
            unzip
    fi

    local build_dir="$HOME/.cache/nvim-build"
    mkdir -p "$build_dir"
    cd "$build_dir"

    if [[ ! -d "neovim" ]]; then
        git clone --depth 1 --branch stable "$NVIM_REPO_URL"
    fi

    cd neovim
    make CMAKE_BUILD_TYPE=Release CMAKE_INSTALL_PREFIX="$NVIM_INSTALL_PREFIX"
    sudo make install

    cd ~/dotfiles
    log "Neovim installed successfully"
}

create_config_dirs() {
    log "Creating config directories..."
    mkdir -p ~/.config/nvim
    mkdir -p ~/.config/tmux
}

setup_dotfiles() {
    if [[ ! -f "dotbot/bin/dotbot" ]]; then
        git submodule update --init --recursive
    fi
    ./dotbot/bin/dotbot -c install.conf.yaml
}

setup_devconfig() {
    if [[ "$CONFIG_MODE" != "work" ]]; then
        return 0
    fi

    local devconfig_dir="$HOME/devconfig"

    if [[ -d "$devconfig_dir/.git" ]]; then
        log "Updating devconfig..."
        git -C "$devconfig_dir" pull
    else
        log "Cloning devconfig (work mode)..."
        git clone "$DEVCONFIG_REPO_URL" "$devconfig_dir"
    fi
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --work)
                CONFIG_MODE="work"
                shift
                ;;
            --personal)
                CONFIG_MODE="personal"
                shift
                ;;
            --help|-h)
                echo "Usage: $0 [OPTIONS]"
                echo "Options:"
                echo "  --work       Set device mode to work"
                echo "  --personal   Set device mode to personal"
                echo "  --help       Show this help message"
                exit 0
                ;;
            *)
                shift
                ;;
        esac
    done
}

# --- Main ---
main() {
    parse_args "$@"

    if [[ -z "$CONFIG_MODE" ]]; then
        if ! load_config_mode; then
            prompt_config_mode
        else
            log "Loaded mode: $CONFIG_MODE"
        fi
    else
        save_config_mode
        log "Mode set to: $CONFIG_MODE"
    fi

    log "Starting dotfiles setup..."

    create_config_dirs

    if check_nvim_version; then
        log "Neovim $(check_nvim_version) is installed and up to date"
    else
        install_neovim_from_source
    fi

    setup_devconfig
    setup_dotfiles
    log "Setup complete!"
}

main "$@"
